<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Login</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f6f8fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }

    .login-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 320px;
      text-align: center;
    }

    h2 {
      margin-top: 0;
      color: #333;
    }

    label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      text-align: left;
      color: #555;
      font-size: 0.9rem;
    }

    input {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
    }

    input:focus {
      border-color: #0078d7;
      box-shadow: 0 0 0 2px rgba(0, 120, 215, 0.2);
    }

    .btn {
      margin-top: 1rem;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    #loginBtn {
      background: #0078d7;
      color: white;
    }

    #loginBtn:hover {
      background: #005fa3;
    }

    #logoutBtn {
      background: #ccc;
      margin-top: 0.5rem;
    }

    #logoutBtn:hover {
      background: #aaa;
    }

    #status {
      margin-top: 1rem;
      font-weight: 500;
    }

    .code-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .code-group input {
      flex: 1;
    }

    .code-group button {
      padding: 0.5rem;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.3s;
    }

    .code-group button:hover {
      background: #ddd;
    }

    .link {
      margin-top: 12px;
      text-align: center;
      font-size: 0.9rem;
    }

    .link a {
      color: #3498db;
      text-decoration: none;
    }

    .link a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <h2>Login</h2>
  <div class="login-card">
    <!-- åˆ‡æ¢æŒ‰é’® -->
    <div style="text-align:center; margin-bottom:1rem;">
      <button type="button" id="toggleLoginBtn">API Key è®¤è¯</button>
    </div>

    <!-- ç”¨æˆ·å/å¯†ç ç™»å½• -->
    <form id="loginForm">
      <div id="userPassSection">
        <label>Username: <input name="username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" /></label><br />
        <label>Password: <input name="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç æˆ–ç•™ç©º" /></label><br />
        <div id="codeSection" style="display:none;">
          <label>Code</label>
          <div class="code-group">
            <input name="code" type="text" placeholder="è¾“å…¥éªŒè¯ç " maxlength="6" />
            <button type="button" id="sendCodeBtn">è·å–éªŒè¯ç </button>
          </div>
        </div>
      </div>

      <!-- API Key ç™»å½• -->
      <div id="apiKeySection" style="display:none;">
        <label>API Key: <input name="api_key" type="text" placeholder="è¾“å…¥ API Keyï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨ç”Ÿæˆè®¿é—®ä»¤ç‰Œ" /></label>
      </div>

      <button id="loginBtn" class="btn" type="submit">Login</button>
      <button id="logoutBtn" class="btn" type="button">Logout</button>
    </form>

    <div id="status"></div>
  </div>

  <div class="link">
    æ²¡æœ‰è´¦å·ï¼Ÿ<a href="/register">æ³¨å†Œ</a>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const form = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');

    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const codeSection = document.getElementById('codeSection');

    const toggleBtn = document.getElementById('toggleLoginBtn');
    const userPassSection = document.getElementById('userPassSection');
    const apiKeySection = document.getElementById('apiKeySection');

    function setStatus(text, color = 'black') {
      statusEl.textContent = text;
      statusEl.style.color = color;
    }

    // åˆ‡æ¢ç™»å½•æ–¹å¼
    toggleBtn.addEventListener('click', () => {
      if (userPassSection.style.display !== 'none') {
        userPassSection.style.display = 'none';
        apiKeySection.style.display = '';
        toggleBtn.textContent = 'è´¦å·ç™»å½•';
      } else {
        apiKeySection.style.display = 'none';
        userPassSection.style.display = '';
        toggleBtn.textContent = 'API Key è®¤è¯';
      }
    });

    async function sendCode(username) {
      try {
        const resp = await fetch(`/send_wechat_code?username=${encodeURIComponent(username)}`);
        const data = await resp.json();
        if (resp.ok) setStatus('ğŸ“¨ éªŒè¯ç å·²å‘é€ï¼Œè¯·æ£€æŸ¥å¾®ä¿¡æ¶ˆæ¯', 'green');
        else setStatus('âŒ å‘é€éªŒè¯ç å¤±è´¥ï¼š' + data.detail, 'red');
      } catch (e) {
        setStatus('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•å‘é€éªŒè¯ç ', 'red');
      }
    }
    async function loginWithUserPass(formData) {
      const username = formData.get('username');
      const password = formData.get('password');
      const code = formData.get('code');

      if (!username) {
        setStatus('è¯·è¾“å…¥ç”¨æˆ·å', 'red');
        return;
      }

      // å¦‚æœæ²¡æœ‰å¯†ç ï¼Œä¹Ÿæ²¡æœ‰éªŒè¯ç  â†’ å…ˆè§¦å‘å‘é€éªŒè¯ç 
      if (!password && !code) {
        codeSection.style.display = 'block';
        await sendCode(username);
        return;
      }

      // å‡†å¤‡ JSON payload
      const payload = { username, password, code };

      try {
        const resp = await fetch('/authenticate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload),
          credentials: 'same-origin' // <--- å…³é”®ï¼šå…è®¸æµè§ˆå™¨æ¥æ”¶ HttpOnly cookieï¼ˆSet-Cookieï¼‰
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ detail: 'login failed' }));
          setStatus(`âŒ ç™»å½•å¤±è´¥: ${err.detail || JSON.stringify(err)}`, 'red');
          return;
        }

        const json = await resp.json();
        // json.access_token contains token returned in body (optional)
        if (json.access_token) {
          // 1) å¯é€‰ï¼šå­˜è¿› localStorageï¼ˆæ³¨æ„ XSS é£é™©ï¼‰
          localStorage.setItem('access_token', json.access_token);
          // 2) è®¾ç½®å…¨å±€å˜é‡æˆ– wrapperï¼Œç”¨äºåç»­è®¾ç½® Authorization headerï¼Œç«‹å³å¯ç”¨ï¼ˆå½“å‰é¡µï¼‰
          window.__ACCESS_TOKEN = json.access_token;
        }

        setStatus('âœ… ç™»å½•æˆåŠŸï¼Œå³å°†è·³è½¬...', 'green');
        setTimeout(() => (window.location.href = '/'), 800);// éœ€è¦è·³è½¬çš„é¡µé¢

      } catch (e) {
        console.error('login error', e);
        setStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'red');
      }
    }

    // API Key ç™»å½•
    async function loginWithApiKey(formData) {
      const api_key = formData.get('api_key');
      if (!api_key) return setStatus('è¯·è¾“å…¥ API Key', 'red');
      try {
        const body = new URLSearchParams();
        body.append("api_key", api_key);
        const resp = await fetch('/api/login', {
          method: 'POST',
          body: body,
          credentials: 'same-origin'
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          return setStatus('âŒ ç™»å½•å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'), 'red');
        }
        const json = await resp.json();
        if (json.access_token) {
          window.__ACCESS_TOKEN = json.access_token;
          localStorage.setItem('access_token', json.access_token);
          sessionStorage.setItem('auth_token', json.access_token);
          setStatus('âœ… ç™»å½•æˆåŠŸï¼Œaccess token å·²ä¿å­˜', 'green');
          setTimeout(() => (window.location.href = '/'), 800);
        }
      } catch (e) {
        setStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'red');
      }
    }

    form.addEventListener('submit', (ev) => {
      ev.preventDefault();
      const fd = new FormData(form);
      if (userPassSection.style.display !== 'none') loginWithUserPass(fd);
      else loginWithApiKey(fd);
    });

    logoutBtn.addEventListener('click', async () => {
      window.__ACCESS_TOKEN = undefined;
      localStorage.removeItem('access_token');
      sessionStorage.removeItem('auth_token');
      setStatus('å·²ç™»å‡º');

      try {
        await fetch('/api/logout', {
          method: 'POST',
          credentials: 'include' // è®©æµè§ˆå™¨å¸¦ä¸Š cookie 'same-origin' 
        });
      } catch (e) {
        console.error('ç™»å‡ºå¤±è´¥:', e);
      }
    });
    sendCodeBtn.addEventListener('click', async () => {
      const username = form.querySelector('[name="username"]').value.trim();
      if (!username) return setStatus('è¯·è¾“å…¥ç”¨æˆ·ååå†è·å–éªŒè¯ç ', 'red');
      await sendCode(username);
    });

  </script>
</body>

</html>