<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenAI — 聊天</title>
  <style>
    /* 全屏布局，去除页面左右空白 */
    :root {
      --bg-0: #1b1c1f;
      /* 页面主背景 */
      --bg-1: #232428;
      /* 次要深色 */
      --panel: #2b2c31;
      /* 面板背景 */
      --muted: rgba(226, 232, 240, 0.55);
      --text: #f1f5f9;
      --border-weak: rgba(255, 255, 255, 0.08);
      --accent: #10a37f;
      /* 主色，可换成蓝色#2563eb */
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg-0);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      /* font-smooth: always; */
    }

    .app {
      height: 100dvh;
      width: 100vw;
      display: grid;
      grid-template-rows: 60px 1fr auto;
      max-width: 100%;
      margin: 0
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      background: transparent;
      border-bottom: 1px solid var(--border-weak);
    }

    header h1 {
      font-size: 16px;
      margin: 0
    }

    #top-controls {
      margin-left: auto;
      display: flex;
      gap: 8px
    }

    main#chat-area {
      overflow: auto;
      overflow-y: auto;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
      background: linear-gradient(var(--bg-1), var(--bg-0));
      box-sizing: border-box;
    }

    .chat-empty {
      color: #8b8f98;
      text-align: center;
      padding: 24px
    }

    /* 气泡 */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 7px
    }

    .msg-row.user {
      justify-content: flex-end
    }

    .bubble {
      max-width: 78%;
      padding: 8px 10px;
      border-radius: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      font-size: 14px;
      color: var(--text);
    }

    .bubble.user {
      background: #004f99;
      border-bottom-right-radius: 6px
    }

    .bubble.assistant {
      background: transparent;
      border: none !important;
      box-shadow: none !important;
      padding: 2px 0;
    }

    /* Markdown 渲染容器 */
    .bubble.markdown {
      font-size: 14px;
      /* 字体大小 */
      line-height: 1.35;
      /* 控制行高 */
      letter-spacing: normal;
      /* 字间距恢复正常 */
      word-break: break-word;
      /* 防止长词撑开 */
      margin: 0;
      padding: 0;
    }

    .bubble.assistant.markdown h1,
    .bubble.assistant.markdown h2,
    .bubble.assistant.markdown h3,
    .bubble.assistant.markdown h4,
    .bubble.assistant.markdown h5,
    .bubble.assistant.markdown h6 {
      margin: 0.1em 0;
      font-weight: bold;
      line-height: 1.2;
    }

    /* 段落 */
    .bubble.assistant.markdown p,
    .bubble.assistant.markdown li,
    .bubble.assistant.markdown li p {
      margin: 0;
    }

    /* 水平线 */
    .bubble.assistant.markdown hr {
      margin: 0.05em 0;
      border: none;
      border-top: 1px solid #ccc;
    }

    /* 列表 */
    .bubble.assistant.markdown ul,
    .bubble.assistant.markdown ol {
      margin: 0.05em 0;
      padding-left: 1.2em;
    }

    /* 表格 */
    .bubble.assistant.markdown table {
      margin: 0.15em 0;
      border-collapse: collapse;
      max-width: 100%;
      overflow-x: auto;
    }

    .bubble.assistant.markdown th,
    .bubble.assistant.markdown td {
      padding: 0.2em 0.4em;
      border: 1px solid #ddd;
      text-align: left;
    }


    /* 代码块 */
    .bubble.markdown pre {
      padding: 0.3em 0.4em;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.35;
      background: #000 !important;
      color: #e2e8f0 !important;
      overflow-x: auto;
      border-radius: 4px;
      margin: 0; 
    }

    .bubble.assistant.markdown pre code {
      font-family: inherit;
      font-size: inherit;
      margin: 0;
      padding: 0;
      background: none;
      color: inherit;
    }

    .meta {
      font-size: 11px;
      color: var(--muted);
      margin-left: 4px
    }

    /* small helpers */
    .muted {
      color: var(--muted);
      font-size: 12px
    }

    footer {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid #e6e7eb;
      background: transparent;
      border-top: 1px solid var(--border-weak);
    }

    .left-compose {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 8px
    }

    .left-compose textarea#input {
      width: 100%;
      box-sizing: border-box;
      min-height: 72px;
      resize: vertical;
    }

    textarea#input {
      width: 100%;
      min-height: 72px;
      resize: vertical;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px
    }

    textarea#input,
    select,
    input[type=file],
    .system-item textarea {
      background: var(--bg-1);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--text);
    }


    .compose-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .right-actions {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: 0;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer
    }

    .btn.secondary {
      background: rgba(255, 255, 255, 0.03);
      color: var(--text)
    }

    .small {
      font-size: 13px;
      padding: 6px 8px
    }

    select,
    input[type=file] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd
    }

    .tools-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .right-panel {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .tool-title {
      font-size: 13px;
      color: #cbd5e1;
    }

    .model-select {
      min-width: 150px;
      /* max-width: 250px; */
    }

    @media (max-width:768px) {
      .app {
        grid-template-rows: 60px 1fr auto
      }

      .right-panel {
        width: 200px
      }

      textarea#input {
        font-size: 16px;
        min-height: 60px;
      }

      .bubble {
        max-width: 90%;
        font-size: 14px;
        word-wrap: break-word;
      }

      footer {
        flex-direction: column;
        gap: 8px;
      }

      .right-actions {
        flex-direction: row;
        justify-content: flex-end;
      }
    }

    /* 设置弹窗 */
    .modal-backdrop {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.35);
      /* 不透明遮罩 */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200
    }

    .modal {
      background: var(--panel);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.75);
      color: var(--text);
      border-radius: 8px;
      padding: 16px;
      width: 520px;
      max-width: 95%;
    }

    .modal h3 {
      margin: 0 0 8px 0
    }

    .modal hr {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 8px 0
    }

    .modal .row label {
      min-width: 110px;
      font-size: 13px;
      color: var(--text);
    }

    .modal input,
    .modal textarea,
    .modal select {
      background: var(--bg-1);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 6px;
    }

    .modal input:focus,
    .modal textarea:focus,
    .modal select:focus {
      border-color: #3b82f6;
      outline: none;
    }

    .modal .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px
    }

    .system-list {
      max-height: 220px;
      overflow: auto;
      padding: 8px;
      border-radius: 6px;
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--text);
    }

    .system-item {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      padding: 6px;
      background: var(--bg-2);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      margin-bottom: 6px
    }

    .system-item textarea {
      flex: 1;
      min-width: 250px;
      min-height: 50px;
      resize: vertical;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px
    }

    .system-controls {
      min-width: 60px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    .system-controls button,
    .system-controls input[type=checkbox] {
      width: auto;
      min-width: 30px;
    }

    /* loading bar */
    .loading-bar {
      display: none;
      position: fixed;
      left: 0;
      top: 60px;
      height: 3px;
      width: 100%;
      background: #f3f3f3;
      z-index: 150
    }

    .loading-bar .progress {
      width: 0;
      height: 100%;
      background: var(--accent);
      transition: width 300ms linear
    }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="Chat App">
    <header>
      <h1>OpenAI — 聊天</h1>
      <div id="top-controls">
        <button id="clear-chat" class="btn secondary small">清空对话</button>
        <button id="download-chat" class="btn secondary small">导出对话</button>
        <button id="open-settings" class="btn small">设置</button>
      </div>
    </header>
    <div class="loading-bar" id="loading-bar">
      <div class="progress" id="loading-progress"></div>
    </div>

    <main id="chat-area">
      <div id="chat-empty-note" class="chat-empty">还没有对话，输入内容并发送开始聊天。</div>
    </main>


    <footer>
      <div class="left-compose" style="flex:1;display:flex;flex-direction:column;gap:8px">
        <!-- 文本框与发送按钮并排 -->
        <div style="display:flex;gap:8px;align-items:flex-end">
          <textarea id="input" placeholder="请输入消息，然后按发送（Shift+Enter 换行）"
            style="flex:1;min-height:72px;resize:vertical;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px"></textarea>
          <div class="right-actions" style="display:flex;flex-direction:column">
            <button id="send-btn" class="btn small">发送</button>
          </div>
        </div>

        <!-- 工具行：流式/网页搜索/文件 与 模型 并排 -->
        <div style="display:flex;align-items:center;gap:16px;margin-top:4px">
          <div class="tools-row">
            <label><input id="websearch-checkbox" type="checkbox"> 网页搜索</label>
            <label><input id="thinking-checkbox" type="checkbox"> 思考</label>
            <label><input id="markdown-checkbox" type="checkbox" checked> 渲染</label>
            <label class="small">文件：<input id="file-input" type="file" multiple></label>
            <label class="tool-title">模型：<select id="model-select" class="model-select"></select></label>
          </div>
        </div>
      </div>
    </footer>
  </div>


  <!-- 设置弹窗 -->
  <div class="modal-backdrop" id="settings-modal">
    <div class="modal">
      <h3>参数设置</h3>
      <div class="row"><label for="topn">上下文数量</label>
        <input id="cfg-topn" type="number" min="4" max="100" step="2" value="20">
      </div>
      <div class="row"><label>最大回复长度（max_tokens）</label><input id="cfg-max-tokens" type="number" min="100" max="10000"
          step="50" value="4000"></div>
      <div class="row"><label>核采用率（top_p）</label><input id="cfg-topp" type="number" min="0" max="1" step="0.01"
          value="1.0"></div>
      <div class="row"><label>温度系数（temperature）</label><input id="cfg-temp" type="number" min="0" max="1" step="0.01"
          value="0.4"></div>
      <div class="row"><label>备用模型（model）</label><select id="cfg-model" class="model-select"
          style="flex:1;padding:6px;border:1px solid #ddd;border-radius:6px"></select><button id="reload-models"
          class="btn small">刷新</button></div>
      <div class="row"><label>流式输出（stream）</label><input id="cfg-stream" type="checkbox" checked></div>

      <hr>
      <h4> 系统提示（System）</h4>
      <div class="row"><label>新增</label>
        <textarea id="new-system-text" placeholder="输入一个 system 提示，按 ‘添加’ 保存"
          style="flex:1;padding:6px;border:1px solid #ddd;border-radius:6px;min-height:80px"></textarea>
        <div style="width:30px;display:flex;align-items:center;justify-content:flex-end">
          <button id="add-system" class="btn small">添加</button>
        </div>
      </div>
      <div class="row"><label>已保存</label>
        <div class="system-list" id="system-list"></div>
      </div>

      <div class="actions">
        <button id="cfg-cancel" class="btn secondary small">取消</button>
        <button id="cfg-save" class="btn small">保存</button>
      </div>
    </div>
  </div>
  <script type="module">
    const el = id => document.getElementById(id);
    // 纯 JavaScript 实现（无 TypeScript）
    const chatArea = el('chat-area');
    const inputEl = el('input');
    const sendBtn = el('send-btn');
    const websearchCheckbox = el('websearch-checkbox');
    const thinkingCheckbox = el('thinking-checkbox');
    const MarkdownCheckbox = el('markdown-checkbox');
    const fileInput = el('file-input');
    const modelSelect = el('model-select');
    const clearBtn = el('clear-chat');
    const downloadBtn = el('download-chat');
    const chatEmptyNote = el('chat-empty-note');

    const settingsModal = el('settings-modal');
    const cfgMaxTokens = el('cfg-max-tokens');
    const cfgTopn = el('cfg-topn');
    const cfgTopp = el('cfg-topp');
    const cfgTemp = el('cfg-temp');
    const cfgStream = el('cfg-stream');
    const cfgModel = el('cfg-model');
    const cfgSave = el('cfg-save');
    const cfgCancel = el('cfg-cancel');
    const openSettingsBtn = el('open-settings');
    const reloadModelsBtn = el('reload-models');
    // system related
    const systemListEl = el('system-list');
    const newSystemText = el('new-system-text');
    const addSystemBtn = el('add-system');

    const loadingBar = el('loading-bar');
    const loadingProgress = el('loading-progress');
    const defaultModel = 'gpt-3.5-turbo';//gpt-4o

    let chatHistory = []; // {role, content, time}
    let lastAssistantPlaceholder = null;
    let streamFinished = false;
    let sseBuffer = '';
    let settings = {
      model: defaultModel, // cfg-model fallback default -> gpt-4o as requested
      temperature: 0.4,
      top_p: 1.0,
      top_n: 20, // 默认取最后 20 条上下文
      max_tokens: 4000,
      stream: true,

      systemPrompts: [], // {id, content}
      selectedSystemIds: [] // ids of systemPrompts to prepend
    };
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

    function renderChat() {
      // render all messages
      chatArea.innerHTML = '';
      if (chatHistory.length === 0) { chatArea.appendChild(chatEmptyNote); return; }
      for (const m of chatHistory) {
        const row = document.createElement('div');
        row.className = 'msg-row ' + (m.role === 'user' ? 'user' : (m.role === 'assistant' ? 'assistant' : ''));
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (m.role === 'user' ? 'user' : 'assistant');
        bubble.innerHTML = m.markdownhtml ?? escapeHtml(m.content);
        if (m.markdownhtml) bubble.className += ' markdown';
        row.appendChild(bubble);
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${m.role}${m.time ? ' • ' + new Date(m.time).toLocaleTimeString() : ''}`;
        row.appendChild(meta);
        chatArea.appendChild(row);
      }
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function scheduleRender() {
      if (pendingRender) return;
      pendingRender = true;
      setTimeout(async () => {
        if (lastAssistantPlaceholder) {
          lastAssistantPlaceholder.markdownhtml = await renderMarkdown(lastAssistantPlaceholder.content);
          renderChat(); // 不需要传参数，renderChat 会用 markdownHtml
        }
        pendingRender = false;
      }, 50); // 每 50ms 批量渲染一次
    }

    function addMessage(role, content, markdownhtml = null) { const item = { role, content, time: Date.now(), markdownhtml }; chatHistory.push(item); renderChat(); return item; }

    async function fileToBase64(file) {
      console.log('[chat] fileToBase64 start', file.name, file.size);
      return new Promise((resolve, reject) => { const r = new FileReader(); r.onload = () => resolve(r.result); r.onerror = reject; r.readAsDataURL(file); });
    }
    async function renderMarkdown(rawText) {
      let bodyData = { text: rawText, html: false };
      try {
        // 尝试解析成 JSON
        const parsed = JSON.parse(rawText);
        if (typeof parsed === 'object' && parsed !== null) {
          // JSON 对象或数组 → 结构化对象
          bodyData = parsed;
        }
      } catch {
        // 解析失败 → 普通 Markdown
      }

      try {
        let res = await fetch("/markdown/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyData),
        });

        if (!res.ok)
          res = await fetch(`/markdown/?text=${encodeURIComponent(rawText)}`);

        if (!res.ok)
          throw new Error(`Markdown 转换失败: ${res.status}`);

        let html = await res.text();
        return html.replace(/\n{2,}/g, '\n'); // 多个换行压缩为 1 个
      } catch (e) {
        console.warn('Markdown 渲染失败：', e);
        return escapeHtml(rawText);
      }
    }

    async function collectTools() {
      const tools = [];
      const files = fileInput.files;
      console.log('[chat] collectTools files:', files ? files.length : 0);
      if (files && files.length) { for (const f of files) { try { const dataUrl = await fileToBase64(f); const base64 = dataUrl.split(',')[1]; tools.push({ type: 'file', filename: f.name, size: f.size, content_base64: base64 }); } catch (e) { console.warn('file read fail', f.name, e); } } }
      return tools;
    }

    function showLoading() { loadingBar.style.display = 'block'; loadingProgress.style.width = '4%'; let prog = 4; const tick = setInterval(() => { prog = Math.min(95, prog + Math.random() * 8); loadingProgress.style.width = prog + '%'; if (loadingBar.style.display === 'none') { clearInterval(tick); loadingProgress.style.width = '0%'; } }, 300); }
    function hideLoading() { loadingBar.style.display = 'none'; loadingProgress.style.width = '0%'; }
    function processSSETextChunk(text) { // append to buffer and process complete data: segments
      sseBuffer += text;
      // SSE events are separated by double newlines, but to be robust we look for lines that start with 'data:'
      // split by newline, but keep incomplete tail
      const lines = sseBuffer.split('\n');
      // If last line might be incomplete, keep it in buffer
      sseBuffer = lines.pop();
      for (const rawLine of lines) {
        const line = rawLine.trim();
        if (!line) continue;
        if (!line.startsWith('data:')) {
          // sometimes chunk contains raw JSON without "data:", attempt to parse
          try { const obj = JSON.parse(line); handleSSEObject(obj); } catch (e) { console.warn('parse raw JSON fail', e, line); }
          continue;
        }
        const payload = line.slice(5).trim();
        if (payload === '[DONE]') {
          // stream finished indicator
          streamFinished = true; //finalizeAssistant();
          continue;
        }
        try {
          const obj = JSON.parse(payload);
          handleSSEObject(obj);
        } catch (e) {
          // 非法 JSON，可能是分片，尝试拼接到 buffer（already done)；忽略
          console.warn('parse sse payload fail', e, payload);
        }
      }
    }

    function handleSSEObject(obj) {
      // obj 结构示例： { id:..., choices:[{ delta:{ content: "xxx", reasoning_content: "..." }, finish_reason: null, index:0 }], ... }
      if (!obj || !Array.isArray(obj.choices)) return;
      for (const ch of obj.choices) {
        const delta = ch.delta || {};
        // 优先使用 delta.content，如果没有则尝试 reasoning_content
        const piece = (delta.content != null && delta.content !== undefined) ? delta.content : (delta.reasoning_content != null ? delta.reasoning_content : null);
        if (piece !== null) {
          // append to last assistant placeholder
          if (lastAssistantPlaceholder) {
            lastAssistantPlaceholder.content += piece;
            renderChat();//scheduleRender(); // 流式更新界面
          } else {
            // 没有占位，则新建一条 assistant 并追加
            lastAssistantPlaceholder = addMessage('assistant', piece);
          }
        }
        // 如果逻辑中 finish_reason === 'stop'，则认为结束
        if (ch.finish_reason === 'stop') {
          streamFinished = true;
        }
      }
    }

    function finalizeAssistant() {
      // 释放占位
      lastAssistantPlaceholder = null; sseBuffer = ''; hideLoading();
    }

    // 决定使用哪个模型：优先 model-select (非空)，其次 cfg-model（settings.model），最后默认 'gpt-3.5-turbo'
    function resolveModel() { const pick = (modelSelect && modelSelect.value && modelSelect.value.trim()) ? modelSelect.value.trim() : (settings.model && settings.model.trim() ? settings.model.trim() : defaultModel); return pick; }

    async function sendCurrentMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      console.log('[chat] user input length', text.length);
      addMessage('user', text);
      inputEl.value = '';
      const n = settings.top_n || 20;  // 取最后 n 条上下文
      // 构建 messages：若有选中的 system prompts，先把它们作为 system role 插入
      const systemMessages = (settings.systemPrompts || []).filter(sp => settings.selectedSystemIds.includes(sp.id)).map(sp => ({ role: 'system', content: sp.content }));
      const userAssistantHistory = chatHistory.slice(-n).map(m => ({ role: m.role, content: m.content }));
      const msgs = systemMessages.concat(userAssistantHistory);

      const model = resolveModel();
      const stream = !!settings.stream;
      const tools = await collectTools();
      if (websearchCheckbox.checked) { tools.push({ type: 'web_search', query: text }); }

      const body = { model, messages: msgs, temperature: parseFloat(settings.temperature), top_p: parseFloat(settings.top_p), max_tokens: parseInt(settings.max_tokens, 10), user: 'html:demo', stream: stream };
      // add optional/aux params
      body['tools'] = tools.length ? tools : undefined;
      if (thinkingCheckbox.checked) {
        const thinkingBudget = Math.max(0, Math.min(Math.floor(body.max_tokens / 2), 2048));
        body.extra_body = {
          enable_thinking: true,
          thinking_budget: thinkingBudget,
        };
      }

      // 创建 assistant 占位
      lastAssistantPlaceholder = addMessage('assistant', '');
      showLoading();
      try {
        const res = await fetch('/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) { const txt = await res.text(); throw new Error('HTTP ' + res.status + ' ' + txt); }

        if (stream) {
          if (!res.body) { // fallback: not streamed
            const data = await res.json(); const ai = data.choices?.[0]?.message?.content ?? JSON.stringify(data);
            lastAssistantPlaceholder.content = ai; finalizeAssistant(); renderChat(); return;
          }
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let done = false;
          streamFinished = false;
          while (!done) {
            const { value, done: d } = await reader.read();
            done = d;
            if (value) {
              const chunk = decoder.decode(value, { stream: true });
              // 解析 SSE 样式的 data: ...
              processSSETextChunk(chunk);
            }
            if (streamFinished) {
              if (lastAssistantPlaceholder && MarkdownCheckbox.checked) lastAssistantPlaceholder.markdownhtml = await renderMarkdown(lastAssistantPlaceholder.content);
              finalizeAssistant();
              break;
            }
          }
          // 流结束
          finalizeAssistant(); renderChat();
        } else {
          const data = await res.json();
          const ai = data.choices?.[0]?.message?.content ?? JSON.stringify(data);
          if (lastAssistantPlaceholder) { lastAssistantPlaceholder.content = ai; if (MarkdownCheckbox.checked) lastAssistantPlaceholder.markdownhtml = await renderMarkdown(ai); }
          finalizeAssistant(); renderChat();
        }
      } catch (err) {
        if (lastAssistantPlaceholder) { lastAssistantPlaceholder.content = '生成失败：' + String(err); }
        finalizeAssistant(); renderChat();
        console.error(err);
      }
    }

    // system prompts management
    function renderSystemList() {
      systemListEl.innerHTML = '';
      const arr = settings.systemPrompts || [];
      if (!arr.length) { systemListEl.innerHTML = '<div class="muted">尚无已保存的 system 提示，使用上方输入框添加。</div>'; return; }
      for (const sp of arr) {
        const wrap = document.createElement('div'); wrap.className = 'system-item';
        const ta = document.createElement('textarea'); ta.value = sp.content; ta.readOnly = true; ta.title = '双击编辑，失焦保存';
        ta.addEventListener('dblclick', () => { ta.readOnly = false; ta.focus(); });
        ta.addEventListener('blur', () => { ta.readOnly = true; sp.content = ta.value; saveSettingsToStorage(); });


        const controls = document.createElement('div'); controls.className = 'system-controls';
        const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = settings.selectedSystemIds.includes(sp.id);
        chk.addEventListener('change', () => {
          if (chk.checked) {
            if (!settings.selectedSystemIds.includes(sp.id)) settings.selectedSystemIds.push(sp.id);
          } else { settings.selectedSystemIds = settings.selectedSystemIds.filter(x => x !== sp.id); }
          saveSettingsToStorage();
        });
        const del = document.createElement('button'); del.className = 'btn secondary small'; del.textContent = '删除'; del.addEventListener('click', () => { if (!confirm('删除该 system 提示？')) return; settings.systemPrompts = settings.systemPrompts.filter(x => x.id !== sp.id); settings.selectedSystemIds = settings.selectedSystemIds.filter(x => x !== sp.id); renderSystemList(); saveSettingsToStorage(); });


        controls.appendChild(chk);
        controls.appendChild(del);
        wrap.appendChild(ta);
        wrap.appendChild(controls);
        systemListEl.appendChild(wrap);
      }
    }


    addSystemBtn.addEventListener('click', () => {
      const txt = (newSystemText.value || '').trim(); if (!txt) { alert('请输入 system 提示文本'); return; }
      const id = 'sys_' + Date.now(); settings.systemPrompts.push({ id, content: txt }); settings.selectedSystemIds.push(id); newSystemText.value = ''; renderSystemList(); saveSettingsToStorage();
    });
    async function loadModels() {
      modelSelect.innerHTML = '<option value="">（使用默认配置）</option>';
      cfgModel.innerHTML = '<option value="">（请选择备用模型）</option>';
      try {
        const res = await fetch('/v1/models');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const models = Array.isArray(data.data) ? data.data : [];
        // 如果后端返回对象数组或字符串数组都支持
        for (const m of models) {
          const id = (m && (m.id || m)) || m;
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = id;
          modelSelect.appendChild(opt);
          const opt2 = opt.cloneNode(true);
          cfgModel.appendChild(opt2);
        }
        // 1) 尝试恢复已保存的 settings.model
        const saved = (settings && settings.model) ? settings.model : localStorage.getItem('chat_model');
        if (saved) {
          // 优先把 saved 应用到 cfgModel，如果可选，则选中；同时如果 saved 在 modelSelect 中也选中
          for (const o of cfgModel.options) { if (o.value === saved) { cfgModel.value = saved; break; } }
          for (const o of modelSelect.options) { if (o.value === saved) { modelSelect.value = saved; break; } }
        } else {
          // 没有保存，尝试默认  （若在列表中）
          for (const o of cfgModel.options) { if (o.value === defaultModel) { cfgModel.value = defaultModel; settings.model = defaultModel; break; } }
        }
      } catch (e) {
        console.warn('loadModels failed', e);
        // 保底：确保 cfgModel 中有  选项
        if (!Array.from(cfgModel.options).some(x => x.value === defaultModel)) {
          const a = document.createElement('option'); a.value = defaultModel; a.textContent = defaultModel; cfgModel.appendChild(a);
        }
      }
    }

    // function connectMCP(message) {
    //   const evtSource = new EventSource(`/mcp/stream?message=${encodeURIComponent(message)}`)

    //   evtSource.onmessage = (event) => {
    //     const data = JSON.parse(event.data)
    //     console.log("MCP Event:", data)

    //     // 1. 如果是普通响应块
    //     if (data.type === "message") {
    //       appendResult("MCP 回复", data)
    //     }

    //     // 2. 如果返回工具选择
    //     if (data.type === "tools") {
    //       showToolOptions(data.tools)
    //     }
    //   }

    //   evtSource.onerror = (err) => {
    //     console.error("MCP error", err)
    //     evtSource.close()
    //   }
    // }

    // function showToolOptions(tools) {
    //   const container = document.createElement("div")
    //   container.innerHTML = "<h4>可用工具</h4>"
    //   tools.forEach(t => {
    //     const btn = document.createElement("button")
    //     btn.textContent = `使用 ${t.name}`
    //     btn.onclick = () => {
    //       fetch("/mcp/use_tool", {
    //         method: "POST",
    //         headers: { "Content-Type": "application/json" },
    //         body: JSON.stringify({ tool: t.name })
    //       })
    //     }
    //     container.appendChild(btn)
    //   })
    //   document.getElementById("results").appendChild(container)
    // }

    sendBtn.addEventListener('click', sendCurrentMessage);
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendCurrentMessage(); } });

    clearBtn.addEventListener('click', () => { if (!confirm('确认清空对话？')) return; chatHistory = []; lastAssistantPlaceholder = null; sseBuffer = ''; renderChat(); });

    downloadBtn.addEventListener('click', () => { const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `chat_${new Date().toISOString()}.json`; a.click(); URL.revokeObjectURL(url); });

    reloadModelsBtn.addEventListener('click', loadModels);
    // Settings modal handlers
    openSettingsBtn.addEventListener('click', () => { loadSettingsToForm(); settingsModal.style.display = 'flex'; });
    cfgCancel.addEventListener('click', () => { settingsModal.style.display = 'none'; });
    cfgSave.addEventListener('click', () => { saveSettingsFromForm(); settingsModal.style.display = 'none'; });

    function saveSettingsToStorage() { localStorage.setItem('chat_enhanced_settings', JSON.stringify(settings)); }
    function loadSettingsFromStorage() { try { const s = localStorage.getItem('chat_enhanced_settings'); if (s) { settings = Object.assign(settings, JSON.parse(s)); } } catch (e) { console.warn('load settings fail', e); } }

    function loadSettingsToForm() { loadSettingsFromStorage(); cfgMaxTokens.value = settings.max_tokens; cfgTopp.value = settings.top_p; cfgTemp.value = settings.temperature; cfgStream.checked = !!settings.stream; cfgModel.value = settings.model || defaultModel; cfgTopn.value = settings.top_n; }

    function saveSettingsFromForm() { settings.max_tokens = parseInt(cfgMaxTokens.value, 10) || 4000; settings.top_p = parseFloat(cfgTopp.value) || 1.0; settings.temperature = parseFloat(cfgTemp.value) || 0.4; settings.stream = !!cfgStream.checked; settings.model = (cfgModel.value || defaultModel).trim(); settings.top_n = parseInt(cfgTopn.value, 10) || 20; saveSettingsToStorage(); }


    // 初始
    loadSettingsFromStorage(); loadModels(); renderSystemList(); renderChat();
  </script>
</body>

</html>